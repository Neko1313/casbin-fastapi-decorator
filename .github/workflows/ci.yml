name: CI

on:
  pull_request:
    branches: ["*"]
  push:
    branches: [master]

permissions:
  contents: read

jobs:
  # ---------------------------------------------------------------------------
  # Detect which packages have changed
  # ---------------------------------------------------------------------------
  changes:
    runs-on: ubuntu-latest
    outputs:
      core: ${{ steps.filter.outputs.core }}
      jwt: ${{ steps.filter.outputs.jwt }}
      db: ${{ steps.filter.outputs.db }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            core:
              - 'src/**'
              - 'tests/**'
              - 'pyproject.toml'
              - 'ruff.toml'
              - 'ty.toml'
            jwt:
              - 'packages/casbin-fastapi-decorator-jwt/**'
            db:
              - 'packages/casbin-fastapi-decorator-db/**'

  # ---------------------------------------------------------------------------
  # Core package
  # ---------------------------------------------------------------------------
  core-lint:
    needs: changes
    if: needs.changes.outputs.core == 'true' || github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-groups

      - name: Install workspace extras
        run: uv pip install -e '.[jwt,db]'

      - name: Ruff
        run: uv run ruff check --output-format github src tests

      - name: Bandit
        run: uv run bandit -c pyproject.toml -r src

      - name: Type check
        run: uv run ty check

  core-test:
    needs: changes
    if: needs.changes.outputs.core == 'true' || github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-groups

      - name: Install workspace extras
        run: uv pip install -e '.[jwt,db]'

      - name: Run tests
        run: |
          uv run pytest tests \
            --junitxml=reports/junit.xml \
            --cov=src \
            --cov-report=xml:reports/coverage.xml \
            --cov-report=term-missing

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: core-test-results
          path: reports/

  # ---------------------------------------------------------------------------
  # JWT package
  # ---------------------------------------------------------------------------
  jwt-lint:
    needs: changes
    if: needs.changes.outputs.jwt == 'true' || github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/casbin-fastapi-decorator-jwt
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-groups
        working-directory: .

      - name: Install workspace extras
        run: uv pip install -e '.[jwt,db]'
        working-directory: .

      - name: Ruff
        run: uv run ruff check --output-format github src tests

      - name: Bandit
        run: uv run bandit -c pyproject.toml -r src

      - name: Type check
        run: uv run ty check

  jwt-test:
    needs: changes
    if: needs.changes.outputs.jwt == 'true' || github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/casbin-fastapi-decorator-jwt
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-groups
        working-directory: .

      - name: Install workspace extras
        run: uv pip install -e '.[jwt,db]'
        working-directory: .

      - name: Run tests
        run: |
          uv run pytest tests \
            --junitxml=reports/junit.xml \
            --cov=src \
            --cov-report=xml:reports/coverage.xml \
            --cov-report=term-missing

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jwt-test-results
          path: packages/casbin-fastapi-decorator-jwt/reports/

  # ---------------------------------------------------------------------------
  # DB package
  # ---------------------------------------------------------------------------
  db-lint:
    needs: changes
    if: needs.changes.outputs.db == 'true' || github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/casbin-fastapi-decorator-db
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-groups
        working-directory: .

      - name: Install workspace extras
        run: uv pip install -e '.[jwt,db]'
        working-directory: .

      - name: Ruff
        run: uv run ruff check --output-format github src tests

      - name: Bandit
        run: uv run bandit -c pyproject.toml -r src

      - name: Type check
        run: uv run ty check

  db-test:
    needs: changes
    if: needs.changes.outputs.db == 'true' || github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    defaults:
      run:
        working-directory: packages/casbin-fastapi-decorator-db
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-groups
        working-directory: .

      - name: Install workspace extras
        run: uv pip install -e '.[jwt,db]'
        working-directory: .

      - name: Run tests
        env:
          DATABASE_URL: postgresql+asyncpg://test:test@localhost:5432/test
        run: |
          uv run pytest tests \
            --junitxml=reports/junit.xml \
            --cov=src \
            --cov-report=xml:reports/coverage.xml \
            --cov-report=term-missing

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: db-test-results
          path: packages/casbin-fastapi-decorator-db/reports/

  # ---------------------------------------------------------------------------
  # Final status check (for branch protection rules)
  # ---------------------------------------------------------------------------
  ci-passed:
    if: always()
    needs: [core-lint, core-test, jwt-lint, jwt-test, db-lint, db-test]
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        run: |
          results=( \
            "${{ needs.core-lint.result }}" \
            "${{ needs.core-test.result }}" \
            "${{ needs.jwt-lint.result }}" \
            "${{ needs.jwt-test.result }}" \
            "${{ needs.db-lint.result }}" \
            "${{ needs.db-test.result }}" \
          )
          for r in "${results[@]}"; do
            if [[ "$r" == "failure" || "$r" == "cancelled" ]]; then
              echo "::error::Job failed with result: $r"
              exit 1
            fi
          done
          echo "All CI checks passed (or were skipped)."
