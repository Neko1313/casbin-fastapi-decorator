version: "3"

includes:
  db:
    taskfile: packages/casbin-fastapi-decorator-db/Taskfile.yaml
    dir: packages/casbin-fastapi-decorator-db
  jwt:
    taskfile: packages/casbin-fastapi-decorator-jwt/Taskfile.yaml
    dir: packages/casbin-fastapi-decorator-jwt

tasks:
  install:
    desc: Install all workspace dependencies
    cmds:
      - uv sync --all-groups
      - uv pip install -e '.[jwt,db]'

  # ---------------------------------------------------------------------------
  # Core (src/ + tests/)
  # ---------------------------------------------------------------------------

  core:lint:
    desc: Run linters for core package (use CI=true for reports)
    cmds:
      - |
        if [[ "{{.CI}}" == "true" ]]; then
          echo "Running core linters with CI reports..."
          mkdir -p reports
          uv run ruff check --output-format json --output-file reports/ruff.json src tests
          uv run bandit -c pyproject.toml -r src -o reports/bandit.json --format json
          uv run ty check --output-format github > reports/gl-code-quality-report.json
        else
          echo "Running core linters for development..."
          uv run ruff check --fix src tests
          uv run bandit -c pyproject.toml -r src
          uv run ty check
        fi

  core:test:
    desc: Run core tests (use CI=true for reports)
    cmds:
      - |
        if [[ "{{.CI}}" == "true" ]]; then
          echo "Running core tests with CI reports..."
          mkdir -p reports
          uv run pytest tests \
            --junitxml=reports/junit.xml \
            --cov=src \
            --cov-report=xml:reports/coverage.xml \
            --cov-report=term-missing
        else
          echo "Running core tests for development..."
          uv run pytest tests --cov=src --cov-report=term-missing:skip-covered
        fi

  # ---------------------------------------------------------------------------
  # All packages
  # ---------------------------------------------------------------------------

  lint:
    desc: Run linters for core + all packages
    deps:
      - core:lint
      - db:lint
      - jwt:lint

  tests:
    desc: Run tests for core + all packages
    deps:
      - core:test
      - db:test
      - jwt:test
