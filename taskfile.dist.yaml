version: "3"

tasks:
  install:
    desc: Install dependencies
    cmds:
      - uv sync --all-groups
      - uv pip install -e '.[jwt,db]'
    aliases:
      - backend/install-deps

  lint:
    desc: Run linters (use CI=true for reports)
    cmds:
      - |
        if [[ "{{.CI}}" == "true" ]]; then
          echo "Running linters with CI reports..."
          mkdir -p reports
          uv run ruff check --output-format json --output-file reports/ruff.json src packages tests examples
          uv run bandit -c pyproject.toml -r src packages examples -o reports/bandit.json --format json
          uv run ty check --output-format github > reports/gl-code-quality-report.json
        else
          echo "Running linters for development..."
          uv run ruff check --fix src packages tests examples
          uv run ty check
          uv run bandit -c pyproject.toml -r src packages examples
        fi

  test/core:
    desc: Run core tests (use CI=true for reports)
    cmds:
      - |
        if [[ "{{.CI}}" == "true" ]]; then
          echo "Running tests with CI reports..."
          mkdir -p reports
          uv run pytest tests \
            --junitxml=reports/junit.xml \
            --cov=src \
            --cov-report=xml:reports/coverage.xml \
            --cov-report=term-missing
        else
          echo "Running tests for development..."
          uv run pytest tests --cov=src --cov-report=term-missing:skip-covered
        fi

  test/db:
    desc: Run DB tests (use CI=true for reports)
    dir: packages/casbin-fastapi-decorator-db
    cmds:
      - |
        if [[ "{{.CI}}" == "true" ]]; then
          echo "Running tests with CI reports..."
          mkdir -p reports
          uv run pytest tests \
            --junitxml=reports/junit.xml \
            --cov=src \
            --cov-report=xml:reports/coverage.xml \
            --cov-report=term-missing
        else
          echo "Running tests for development..."
          uv run pytest tests --cov=src --cov-report=term-missing:skip-covered
        fi

  test/jwt:
    desc: Run JWT tests (use CI=true for reports)
    dir: packages/casbin-fastapi-decorator-jwt
    cmds:
      - |
        if [[ "{{.CI}}" == "true" ]]; then
          echo "Running tests with CI reports..."
          mkdir -p reports
          uv run pytest tests \
            --junitxml=reports/junit.xml \
            --cov=src \
            --cov-report=xml:reports/coverage.xml \
            --cov-report=term-missing
        else
          echo "Running tests for development..."
          uv run pytest tests --cov=src --cov-report=term-missing:skip-covered
        fi

  tests:
    desc: Run all tests (use CI=true for reports)
    deps:
      - test/core
      - test/db
      - test/jwt
